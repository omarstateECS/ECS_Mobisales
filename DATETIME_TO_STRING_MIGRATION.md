# DateTime to String Migration Guide

## Overview
This migration converts all DateTime fields in the database to String fields to avoid datetime conversion issues, as the mobile app sends dates as strings.

## Changes Made

### 1. Prisma Schema Updates
All DateTime fields have been converted to String in the following models:
- **Customer**: `createdAt`
- **Salesman**: `createdAt`
- **Authority**: `createdAt`, `updatedAt`
- **SalesmanAuthority**: `createdAt`
- **Visit**: `startTime`, `endTime`, `cancelTime`, `createdAt`, `updatedAt`
- **InvoiceHeader**: `createdAt`, `updatedAt`
- **Reasons**: `createdAt`, `updatedAt`
- **Journies**: `startJourney`, `endJourney`, `createdAt`, `updatedAt`
- **Settings**: `createdAt`, `updatedAt`
- **actionDetails**: `createdAt`
- **actions**: `createdAt`

### 2. Service Layer Updates

#### journeyService.js
- Updated `getAllJourneysWithPagination()` to use string comparison for date filtering
- Removed `new Date()` conversions
- Date filtering now uses string comparison (gte/lte)

#### visitService.js
- Updated `formatTimestamp()` to return strings as-is
- Removed all `new Date()` conversions in `createVisit()` and `updateVisit()`
- Visit timestamps are now stored directly as strings

#### invoiceService.js
- Updated `createInvoice()` to use `new Date().toISOString()` for default dates
- Removed `new Date()` conversion for `createdAt`

#### salesmanService.js
- Updated `parseTimestamp()` to return strings as-is
- Updated visit sorting to use `localeCompare()` for string date comparison

### 3. API Endpoints
No changes required to endpoints - they continue to work with the same request/response format.

## Migration Steps

### Step 1: Backup Database
```bash
pg_dump -U your_username -d ecs_mobisales > backup_before_migration.sql
```

### Step 2: Generate Prisma Migration
```bash
npx prisma migrate dev --name datetime_to_string_conversion
```

### Step 3: Apply Migration
The migration will:
1. Convert all DateTime columns to TEXT/VARCHAR
2. Preserve existing data by converting timestamps to ISO 8601 strings
3. Update indexes to work with string columns

### Step 4: Regenerate Prisma Client
```bash
npx prisma generate
```

### Step 5: Test the Application
1. Test journey creation and retrieval
2. Test visit creation with timestamps
3. Test invoice creation
4. Test date filtering in Tours page
5. Verify mobile app integration

## Date Format
All dates should be in ISO 8601 format **without timezone indicator**:
- `YYYY-MM-DDTHH:mm:ss.sss` (e.g., "2025-10-20T10:30:45.123")
- This format is generated by `new Date().toISOString().replace('Z', '')`
- This format works with string comparison for filtering
- No "Z" at the end to match mobile app format

## Important Notes

1. **String Comparison**: Date filtering now uses string comparison, which works correctly with ISO 8601 format
2. **No Timezone Conversion**: Dates are stored as-is from the mobile app
3. **Backward Compatibility**: The API endpoints remain unchanged
4. **Mobile App**: No changes needed - it already sends dates as strings

## Rollback Plan
If issues occur, restore from backup:
```bash
psql -U your_username -d ecs_mobisales < backup_before_migration.sql
```

Then revert the code changes:
```bash
git revert <commit_hash>
```

## Testing Checklist
- [ ] Create new journey with string dates
- [ ] Filter journeys by date range
- [ ] Create visit with timestamps
- [ ] Create invoice with timestamp
- [ ] Verify Tours page displays correctly
- [ ] Test mobile app sync
- [ ] Verify date sorting works correctly
- [ ] Check all date-related queries
